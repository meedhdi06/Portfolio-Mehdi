const translations = {
    en: {
        navHome: "Home", navAbout: "About", navSkills: "Skills",
        navExperience: "Experience", navEducation: "Education", navContact: "Contact",
        heroName: "Mehdi Affane",
        heroSubtitle: "Software Development Student | Future Full-Stack Developer",
        aboutText: "Passionate about technology since childhood and currently studying Multiplatform Application Development (DAM). I am building strong foundations in programming, databases and software design. I am seeking my first professional IT opportunity to contribute my discipline, analytical mindset and continuous growth mentality.",
        progFundTitle: "Programming Fundamentals",
        sJava: "Java (OOP Fundamentals)", sSql: "SQL & Relational Databases (MySQL)",
        sHtml: "HTML5", sCss: "CSS3", sJs: "Basic JavaScript", sGit: "Git & GitHub",
        softSkillsTitle: "Soft Skills",
        ssDisc: "Discipline", ssAdapt: "Adaptability", ssLearn: "Continuous Learning",
        ssAnaly: "Analytical Thinking", ssResp: "Responsibility", ssAlgo: "Algorithmic Thinking",
        ssProblem: "Problem Solving", ssAgile: "Basic Agile Concepts",
        exp1Role: "Delivery Driver", exp1Date: "2023 – Present",
        exp2Role: "Warehouse Assistant", exp2Date: "2018 – 2025",
        edu1School: "IES San Blas", edu1Date: "2025 – Present", edu1Desc: "Multiplatform Application Development (DAM)",
        edu2School: "IES Mare Nostrum", edu2Date: "Past", edu2Desc: "General Studies",
        contactTitle: "Contact Me", contactName: "Name", contactEmail: "Email", contactMsg: "Message", contactSend: "Send Message",

        // Digital Assistant Speech
        astHero: "Welcome. Let’s build something serious.",
        astAbout: "Strong foundations are everything.",
        astSkills: "The level keeps rising.",
        astExp: "This is just the beginning.",
        astEdu: "Transformation in progress.",
        astContact: "Let’s create value together."
    },
    es: {
        navHome: "Inicio", navAbout: "Sobre mí", navSkills: "Habilidades",
        navExperience: "Experiencia", navEducation: "Educación", navContact: "Contacto",
        heroName: "Mehdi Affane",
        heroSubtitle: "Estudiante de Desarrollo de Software | Futuro Full-Stack Developer",
        aboutText: "Apasionado por la tecnología desde la infancia y actualmente estudiando Desarrollo de Aplicaciones Multiplataforma (DAM). Construyendo bases sólidas en programación, bases de datos y diseño de software. Busco mi primera oportunidad profesional en TI para aportar mi disciplina, mentalidad analítica y deseo de crecimiento continuo.",
        progFundTitle: "Fundamentos de Programación",
        sJava: "Java (Fundamentos POO)", sSql: "SQL y Bases de Datos (MySQL)",
        sHtml: "HTML5", sCss: "CSS3", sJs: "JavaScript Básico", sGit: "Git y GitHub",
        softSkillsTitle: "Habilidades Blandas",
        ssDisc: "Disciplina", ssAdapt: "Adaptabilidad", ssLearn: "Aprendizaje Continuo",
        ssAnaly: "Pensamiento Analítico", ssResp: "Responsabilidad", ssAlgo: "Pensamiento Algorítmico",
        ssProblem: "Resolución de Problemas", ssAgile: "Conceptos Básicos de Agile",
        exp1Role: "Repartidor", exp1Date: "2023 – Presente",
        exp2Role: "Mozo de Almacén", exp2Date: "2018 – 2025",
        edu1School: "IES San Blas", edu1Date: "2025 – Presente", edu1Desc: "Desarrollo de Aplicaciones Multiplataforma (DAM)",
        edu2School: "IES Mare Nostrum", edu2Date: "Anterior", edu2Desc: "Estudios Generales",
        contactTitle: "Contáctame", contactName: "Nombre", contactEmail: "Correo", contactMsg: "Mensaje", contactSend: "Enviar Mensaje",

        astHero: "Bienvenido. Construyamos algo serio.",
        astAbout: "Unas bases sólidas lo son todo.",
        astSkills: "El nivel sigue subiendo.",
        astExp: "Esto es solo el comienzo.",
        astEdu: "Transformación en progreso.",
        astContact: "Vamos a crear valor juntos."
    },
    ar: {
        navHome: "الرئيسية", navAbout: "نبذة عني", navSkills: "المهارات",
        navExperience: "الخبرة", navEducation: "التعليم", navContact: "اتصل بنا",
        heroName: "المهدي عفان",
        heroSubtitle: "طالب تطوير برمجيات | مطور Full-Stack مستقبلي",
        aboutText: "شغوف بالتكنولوجيا منذ الطفولة وأدرس حاليًا تطوير التطبيقات متعددة المنصات (DAM). أبني أسسًا قوية في البرمجة وقواعد البيانات وتصميم البرمجيات. أبحث عن فرصتي المهنية الأولى في مجال تكنولوجيا المعلومات للمساهمة بانضباطي وعقليتي التحليلية ورغبتي في النمو المستمر.",
        progFundTitle: "أساسيات البرمجة",
        sJava: "Java (أساسيات كائنية التوجه)", sSql: "SQL وقواعد البيانات (MySQL)",
        sHtml: "HTML5", sCss: "CSS3", sJs: "JavaScript أساسي", sGit: "Git و GitHub",
        softSkillsTitle: "المهارات الناعمة",
        ssDisc: "الانضباط", ssAdapt: "القدرة على التكيف", ssLearn: "التعلم المستمر",
        ssAnaly: "التفكير التحليلي", ssResp: "المسؤولية", ssAlgo: "التفكير الخوارزمي",
        ssProblem: "حل المشكلات", ssAgile: "مفاهيم Agile الأساسية",
        exp1Role: "عامل توصيل", exp1Date: "2023 – الحاضر",
        exp2Role: "مساعد مستودع", exp2Date: "2018 – 2025",
        edu1School: "معهد سان بلاس", edu1Date: "2025 – الحاضر", edu1Desc: "تطوير التطبيقات متعددة المنصات (DAM)",
        edu2School: "معهد ماري نوستروم", edu2Date: "سابقًا", edu2Desc: "دراسات عامة",
        contactTitle: "اتصل بي", contactName: "الاسم", contactEmail: "البريد الإلكتروني", contactMsg: "الرسالة", contactSend: "إرسال الرسالة",

        astHero: "أهلاً بك. دعنا نبني شيئًا احترافيًا.",
        astAbout: "الأسس القوية هي الأهم.",
        astSkills: "المستوى في ارتفاع مستمر.",
        astExp: "هذه فقط البداية.",
        astEdu: "التحول قيد التقدم.",
        astContact: "دعنا نخلق قيمة معًا."
    }
};

const typedStrings = {
    en: ["Passionate about Technology", "Building My Future in IT", "Learning. Improving. Growing."],
    es: ["Apasionado por la Tecnología", "Construyendo mi futuro en IT", "Aprendiendo. Mejorando. Creciendo."],
    ar: ["شغوف بالتكنولوجيا", "أبني مستقبلي في تقنية المعلومات", "أتعلم. أتحسن. أنمو."]
};

let currentLang = 'en';
let typedInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    initLanguageSwitcher();
    initMobileMenu();
    initTyped();
    initGSAPAnimations();
    initScreenAssistant();

    // Header scroll background behavior
    const header = document.querySelector('header');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 50) header.classList.add('scrolled');
        else header.classList.remove('scrolled');
    });
});

function initLanguageSwitcher() {
    const langSwitch = document.getElementById('lang-switch');
    langSwitch.addEventListener('change', (e) => {
        currentLang = e.target.value;
        const root = document.documentElement;

        root.setAttribute('lang', currentLang);
        root.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');

        // Update all translation texts
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) {
                // Skip the container for heroName in standard innerText swap, 
                // because we need the span.char logic to remain intact.
                if (key === 'heroName') {
                    // Update the array & DOM for GSAP animated text dynamically
                    const heroNameTextContainer = document.querySelector('.name-text');
                    const newHeroName = translations[currentLang][key].split("");
                    heroNameTextContainer.innerHTML = "";
                    newHeroName.forEach(char => {
                        const span = document.createElement("span");
                        span.className = "char";
                        span.style.opacity = "1"; // instantly visible post-load
                        span.style.transform = "translateY(0)";
                        span.innerHTML = char === " " ? "&nbsp;" : char;
                        heroNameTextContainer.appendChild(span);
                    });
                } else {
                    el.innerText = translations[currentLang][key];
                }
            }
        });

        // Restart Typed
        initTyped();
    });
}

function initTyped() {
    if (typedInstance) typedInstance.destroy();
    typedInstance = new Typed('#typed-output', {
        strings: typedStrings[currentLang],
        typeSpeed: 40,
        backSpeed: 25,
        backDelay: 2000,
        loop: true,
        showCursor: true,
        cursorChar: '|'
    });
}

function initMobileMenu() {
    const hamburger = document.querySelector('.hamburger');
    const navLinks = document.querySelector('.nav-links');

    hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('active');
        const icon = hamburger.querySelector('i');
        icon.classList.toggle('fa-bars');
        icon.classList.toggle('fa-times');
    });

    document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', () => {
            navLinks.classList.remove('active');
            hamburger.querySelector('i').classList.replace('fa-times', 'fa-bars');
        });
    });
}

// -----------------------------------------------------
// GSAP & ScrollTrigger Animations
// -----------------------------------------------------
function initGSAPAnimations() {
    gsap.registerPlugin(ScrollTrigger);

    // Initial Split text setup for hero name on load
    const heroNameTextContainer = document.querySelector('.name-text');
    const heroNameText = translations[currentLang]['heroName'].split("");
    heroNameTextContainer.innerHTML = "";
    heroNameText.forEach(char => {
        const span = document.createElement("span");
        span.className = "char";
        span.innerHTML = char === " " ? "&nbsp;" : char;
        heroNameTextContainer.appendChild(span);
    });

    // 1. Hero Reveal Series
    const tlHero = gsap.timeline();

    tlHero
        .fromTo(".hero-shapes", { opacity: 0, scale: 0.8 }, { opacity: 1, scale: 1, duration: 2, ease: "power2.out" })
        .fromTo(".name-text .char", { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.8, stagger: 0.05, ease: "back.out(1.7)" }, "-=1.5")
        .to(".name-glow", { width: "100%", duration: 1, ease: "power2.out" }, "-=0.5")
        .fromTo(".hero-subtitle", { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.8, ease: "power2.out" }, "-=0.2")
        .fromTo(".hero-typing-container", { opacity: 0 }, { opacity: 1, duration: 0.5 }, "-=0.4")
        .fromTo(".hero-scroll", { y: -20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, ease: "power2.out" }, "-=0.2");

    // General Section Titles
    gsap.utils.toArray('.section-header').forEach(header => {
        gsap.fromTo(header.querySelector('.section-title'),
            { y: 30, opacity: 0 },
            {
                y: 0, opacity: 1, duration: 0.8, ease: "power2.out",
                scrollTrigger: { trigger: header, start: "top 85%" }
            }
        );
        gsap.to(header.querySelector('.title-underline'),
            {
                width: "80px", duration: 1, ease: "power2.out",
                scrollTrigger: { trigger: header, start: "top 85%" }
            }
        );
    });

    // About Section (Slide from LEFT)
    gsap.fromTo(".gsap-reveal-left",
        { x: -50, opacity: 0 },
        {
            x: 0, opacity: 1, duration: 1.2, ease: "power3.out",
            scrollTrigger: { trigger: "#about", start: "top 80%" }
        });

    // Skills Section (Slide from RIGHT)
    gsap.fromTo(".gsap-reveal-right",
        { x: 50, opacity: 0 },
        {
            x: 0, opacity: 1, duration: 1.2, ease: "power3.out",
            scrollTrigger: { trigger: "#skills", start: "top 80%" }
        });

    // Skills Progress Bars Fill
    gsap.utils.toArray('.progress-fill').forEach(bar => {
        gsap.to(bar, {
            width: bar.getAttribute('data-width'),
            duration: 1.5, ease: "power3.out",
            scrollTrigger: { trigger: "#skills", start: "top 70%" }
        });
    });

    // Skills Tags scale up
    gsap.fromTo(".tag",
        { scale: 0.8, opacity: 0 },
        {
            scale: 1, opacity: 1, duration: 0.5, stagger: 0.05, ease: "back.out(1.5)",
            scrollTrigger: { trigger: ".tags-container", start: "top 85%" }
        });

    // Experience Section (Zoom/Depth)
    gsap.utils.toArray('.gsap-reveal-depth').forEach((node, i) => {
        gsap.fromTo(node,
            { scale: 0.9, opacity: 0, z: -50 },
            {
                scale: 1, opacity: 1, z: 0, duration: 1, delay: i * 0.15, ease: "power3.out",
                scrollTrigger: { trigger: "#experience", start: "top 75%" }
            });
    });

    // Education Section (Slide Diagonal)
    gsap.utils.toArray('.gsap-reveal-diagonal').forEach((card, i) => {
        gsap.fromTo(card,
            { x: -30, y: 30, opacity: 0 },
            {
                x: 0, y: 0, opacity: 1, duration: 1, delay: i * 0.15, ease: "power3.out",
                scrollTrigger: { trigger: "#education", start: "top 80%" }
            });
    });

    // Contact Frame (Slide from RIGHT)
    gsap.fromTo(".contact-frame.gsap-reveal-right",
        { x: 50, opacity: 0 },
        {
            x: 0, opacity: 1, duration: 1, ease: "power3.out",
            scrollTrigger: { trigger: "#contact", start: "top 80%" }
        });
}

// -----------------------------------------------------
// Digital Screen Assistant Interactions
// -----------------------------------------------------
function initScreenAssistant() {
    const screenMonitor = document.querySelector('.screen-monitor');
    const speechBubble = document.getElementById('screen-speech');
    const pupils = document.querySelectorAll('.pupil-dot');
    let hideTimeout;

    // Show text bubble logic
    const showSpeech = (key) => {
        const text = translations[currentLang][key];
        if (!text) return;

        speechBubble.innerText = text;
        speechBubble.classList.add('show');

        // Tilt animation on speak
        gsap.fromTo(screenMonitor,
            { rotation: 0 },
            { rotation: -5, duration: 0.2, yoyo: true, repeat: 1, ease: "power1.inOut" }
        );

        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
            speechBubble.classList.remove('show');
        }, 3500);
    };

    // Tracking mouse for pupil movement
    window.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 6; // range -3 to 3
        const y = (e.clientY / window.innerHeight - 0.5) * 4; // range -2 to 2

        pupils.forEach(pupil => {
            // Constrain limits implicitly by low multiplier
            pupil.style.transform = `translate(${x}px, ${y}px)`;
        });
    });

    // Section entry triggers
    const triggerMap = {
        'home': 'astHero',
        'about': 'astAbout',
        'skills': 'astSkills',
        'experience': 'astExp',
        'education': 'astEdu',
        'contact': 'astContact'
    };

    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && entry.intersectionRatio > 0.4) {
                const id = entry.target.id;
                if (triggerMap[id]) showSpeech(triggerMap[id]);
            }
        });
    }, { threshold: 0.4 });

    document.querySelectorAll('section').forEach(sec => sectionObserver.observe(sec));

    // Initial load speech delay
    setTimeout(() => { showSpeech('astHero'); }, 2500);
}
